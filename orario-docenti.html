<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orario Docenti - Visualizzatore</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .status-section {
            padding: 20px 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: white;
            border-radius: 10px;
            font-size: 1.05em;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .status-indicator.loading {
            color: #ff9800;
            border: 2px solid #ff9800;
        }

        .status-indicator.success {
            color: #4caf50;
            border: 2px solid #4caf50;
        }

        .status-indicator.error {
            color: #f44336;
            border: 2px solid #f44336;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff9800;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .search-section {
            padding: 30px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .view-btn {
            padding: 12px 20px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .view-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .view-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .options-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f5f7fa;
            border-radius: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            transition: all 0.3s ease;
        }

        .checkbox-option:hover {
            transform: translateY(-2px);
        }

        .checkbox-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .checkbox-option label {
            cursor: pointer;
            font-size: 1.05em;
            color: #333;
            font-weight: 500;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-select {
            flex: 1;
            min-width: 250px;
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .search-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        .search-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .schedule-section {
            padding: 30px;
            display: none;
        }

        .teacher-info {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .teacher-info h2 {
            color: #333;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .teacher-info .stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .teacher-info .stat-item {
            background: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.95em;
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .schedule-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .schedule-table th {
            padding: 15px;
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9em;
        }

        .schedule-table td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #f0f0f0;
            position: relative;
            min-height: 60px;
            vertical-align: top;
        }

        .schedule-table tbody tr:hover {
            background: #f8f9fa;
        }

        .schedule-table td:last-child {
            border-right: none;
        }

        .schedule-table tbody tr:last-child td {
            border-bottom: none;
        }

        .time-slot {
            font-weight: 600;
            color: #667eea;
            background: #f5f7fa;
        }

        .class-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 8px;
            background: #e8f5e9;
            border-radius: 8px;
            min-height: 50px;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .class-info:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .class-info.lab-session {
            background: #fff3e0;
        }

        .class-name {
            font-weight: 600;
            color: #2e7d32;
            font-size: 1.1em;
        }

        .subject-name {
            font-size: 0.9em;
            color: #555;
            font-style: italic;
        }

        .lab-info {
            font-size: 0.9em;
            color: #1565c0;
            background: #e3f2fd;
            padding: 3px 8px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 3px;
        }

        .docente-info {
            font-size: 0.85em;
            color: #1976d2;
            background: #e3f2fd;
            padding: 3px 8px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 3px;
            font-weight: 500;
        }

        .docente-lab-info {
            font-size: 0.85em;
            color: #388e3c;
            background: #e8f5e9;
            padding: 3px 8px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 3px;
            font-weight: 500;
        }

        .compresenza-info {
            font-size: 0.85em;
            color: #d32f2f;
            background: #ffebee;
            padding: 3px 8px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 3px;
            font-weight: 500;
        }

        .empty-slot {
            color: #ccc;
            font-style: italic;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #667eea;
        }

        .retry-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .info-message {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border: 1px solid #64b5f6;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .schedule-table {
                font-size: 0.85em;
            }
            
            .schedule-table th, .schedule-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Orario Docenti</h1>
            <p>Visualizza l'orario di ogni docente</p>
        </div>

        <div class="status-section">
            <div class="status-indicator loading" id="statusIndicator">
                <div class="spinner"></div>
                <span>Caricamento dati in corso...</span>
            </div>
        </div>

        <div class="search-section" id="searchSection" style="display: none;">
            <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="view-btn active" data-view="docente" onclick="switchView('docente')">
                        üë®‚Äçüè´ Vista Docente
                    </button>
                    <button class="view-btn" data-view="classe" onclick="switchView('classe')">
                        üìö Vista Classe
                    </button>
                    <button class="view-btn" data-view="laboratorio" onclick="switchView('laboratorio')">
                        üî¨ Vista Laboratorio
                    </button>
                </div>
            </div>
            
            <div class="search-container">
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       placeholder="üîç Cerca docente per nome...">
                <select class="search-select" id="searchSelect">
                    <option value="">-- Seleziona un docente --</option>
                </select>
                <button class="search-btn" id="searchBtn">Visualizza Orario</button>
            </div>
            
            <div class="options-container" id="optionsDocente">
                <div class="checkbox-option">
                    <input type="checkbox" id="showLab" checked>
                    <label for="showLab">üî¨ Mostra laboratori</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="showCompresenze" checked>
                    <label for="showCompresenze">üë• Mostra compresenze</label>
                </div>
            </div>
            
            <div class="options-container" id="optionsClasse" style="display: none;">
                <div class="checkbox-option">
                    <input type="checkbox" id="showDocenteClasse" checked>
                    <label for="showDocenteClasse">üë®‚Äçüè´ Mostra docenti</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="showLabClasse" checked>
                    <label for="showLabClasse">üî¨ Mostra laboratori</label>
                </div>
            </div>
            
            <div class="options-container" id="optionsLaboratorio" style="display: none;">
                <div class="checkbox-option">
                    <input type="checkbox" id="showCompresenzeLab" checked>
                    <label for="showCompresenzeLab">üë• Mostra compresenze</label>
                </div>
            </div>
            
            <div id="messageArea"></div>
        </div>

        <div class="schedule-section" id="scheduleSection">
            <div class="teacher-info" id="teacherInfo"></div>
            <table class="schedule-table" id="scheduleTable">
                <thead>
                    <tr>
                        <th>Ora</th>
                        <th>Luned√¨</th>
                        <th>Marted√¨</th>
                        <th>Mercoled√¨</th>
                        <th>Gioved√¨</th>
                        <th>Venerd√¨</th>
                    </tr>
                </thead>
                <tbody id="scheduleBody">
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        let csvData = [];
        let teachers = new Set();
        let classes = new Set();
        let laboratories = new Set();
        let currentView = 'docente';
        let currentSchedule = {};

        // URL diretto del file CSV su GitHub Raw
        const CSV_URL = 'https://raw.githubusercontent.com/nicvac-teach/Filebox/main/orario_mat_labs.csv';

        // Mappatura giorni (numero -> nome) - Sabato rimosso
        const dayMapping = {
            1: 'Luned√¨',
            2: 'Marted√¨',
            3: 'Mercoled√¨',
            4: 'Gioved√¨',
            5: 'Venerd√¨'
        };

        // Funzione per cambiare vista (deve essere globale per onclick)
        window.switchView = function(view) {
            currentView = view;
            
            // Aggiorna bottoni attivi
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.view === view) {
                    btn.classList.add('active');
                }
            });
            
            // Nasconde tutte le opzioni
            document.getElementById('optionsDocente').style.display = 'none';
            document.getElementById('optionsClasse').style.display = 'none';
            document.getElementById('optionsLaboratorio').style.display = 'none';
            
            // Mostra le opzioni corrette e aggiorna placeholder
            const searchInput = document.getElementById('searchInput');
            const searchSelect = document.getElementById('searchSelect');
            const searchBtn = document.getElementById('searchBtn');
            
            switch(view) {
                case 'docente':
                    document.getElementById('optionsDocente').style.display = 'flex';
                    searchInput.placeholder = 'üîç Cerca docente per nome...';
                    searchBtn.textContent = 'Visualizza Orario Docente';
                    populateTeacherSelect();
                    break;
                case 'classe':
                    document.getElementById('optionsClasse').style.display = 'flex';
                    searchInput.placeholder = 'üîç Cerca classe...';
                    searchBtn.textContent = 'Visualizza Orario Classe';
                    populateClassSelect();
                    break;
                case 'laboratorio':
                    document.getElementById('optionsLaboratorio').style.display = 'flex';
                    searchInput.placeholder = 'üîç Cerca laboratorio...';
                    searchBtn.textContent = 'Visualizza Orario Laboratorio';
                    populateLaboratorySelect();
                    break;
            }
            
            // Reset selezione e nascondi orario
            searchSelect.value = '';
            searchInput.value = '';
            document.getElementById('scheduleSection').style.display = 'none';
        }

        // Caricamento automatico del file CSV all'avvio
        window.addEventListener('DOMContentLoaded', function() {
            console.log('App inizializzata. URL CSV:', CSV_URL);
            
            // Verifica se siamo in un ambiente che supporta fetch esterni
            if (window.location.protocol === 'file:') {
                console.warn('App aperta da file locale. Il fetch potrebbe non funzionare.');
            }
            
            // Tenta il caricamento
            loadCSVFromURL();
        });

        // Carica il CSV dall'URL
        function loadCSVFromURL() {
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.className = 'status-indicator loading';
            statusIndicator.innerHTML = '<div class="spinner"></div><span>Caricamento dati da GitHub...</span>';

            // Metodo 1: Prova con XMLHttpRequest (pi√π compatibile)
            const xhr = new XMLHttpRequest();
            xhr.open('GET', CSV_URL, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        console.log('CSV caricato con successo via XHR');
                        parseCSV(xhr.responseText);
                        statusIndicator.className = 'status-indicator success';
                        statusIndicator.innerHTML = '‚úÖ Dati caricati con successo da GitHub!';
                        document.getElementById('searchSection').style.display = 'block';
                        
                        setTimeout(() => {
                            statusIndicator.style.display = 'none';
                        }, 3000);
                    } else {
                        // Se XHR fallisce, prova con fetch
                        console.log('XHR fallito, provo con fetch...');
                        tryFetch();
                    }
                }
            };
            xhr.onerror = function() {
                console.log('XHR error, provo con fetch...');
                tryFetch();
            };
            xhr.send();
        }

        // Metodo 2: Fetch come fallback
        function tryFetch() {
            fetch(CSV_URL)
                .then(response => {
                    console.log('Fetch response:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    console.log('CSV caricato con successo via fetch');
                    parseCSV(text);
                    document.getElementById('statusIndicator').className = 'status-indicator success';
                    document.getElementById('statusIndicator').innerHTML = '‚úÖ Dati caricati con successo da GitHub!';
                    document.getElementById('searchSection').style.display = 'block';
                    
                    setTimeout(() => {
                        document.getElementById('statusIndicator').style.display = 'none';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Anche il fetch √® fallito:', error);
                    handleLoadError(error);
                });
        }

        // Gestione errori di caricamento
        function handleLoadError(error) {
            const statusIndicator = document.getElementById('statusIndicator');
            statusIndicator.className = 'status-indicator error';
            
            // Se siamo nell'ambiente Claude.ai, mostra un messaggio specifico
            if (window.location.hostname.includes('claude.ai') || window.location.hostname.includes('anthropic')) {
                statusIndicator.innerHTML = '‚ö†Ô∏è App in modalit√† demo. Carica il CSV manualmente.';
                
                // In ambiente Claude, carica dati di esempio
                loadSampleData();
            } else {
                statusIndicator.innerHTML = '‚ùå Errore nel caricamento. Usa il file CSV locale.';
            }
            
            // Mostra sempre l'opzione di caricamento manuale
            showManualUpload();
            
            // Mostra dettagli errore
            const messageArea = document.getElementById('messageArea') || createMessageArea();
            if (messageArea) {
                messageArea.className = 'info-message';
                messageArea.innerHTML = `
                    ‚ÑπÔ∏è <strong>Nota:</strong><br>
                    Per il caricamento automatico, salva questo file HTML e aprilo nel browser.<br>
                    Oppure carica il CSV manualmente usando il pulsante sopra.
                `;
                messageArea.style.display = 'block';
            }
        }

        // Carica dati di esempio per testing
        function loadSampleData() {
            const sampleCSV = `Classe,Giorno,Ora,Docente,Materia,Laboratorio,DocenteLab,DocenteLabMateria
3IC,1,1,Rossi M.,Matematica,,,
3IC,1,2,Rossi M.,Matematica,,,
3IC,1,3,Vacca N.,Informatica,Lab Info 2,Vacca N.,Informatica
3IC,1,3,Bianchi L.,Informatica,,,
3IC,1,4,Verdi G.,Fisica,Lab Fisica,Verdi G.,Fisica
3IC,1,4,Rossi M.,Fisica,,,
3IC,2,1,Bianchi L.,Italiano,,,
3IC,2,2,Bianchi L.,Italiano,,,
3IC,2,3,Vacca N.,Informatica,Lab Info 2,Neri P.,Informatica
3IC,2,4,Vacca N.,Sistemi,Lab Info 1,Vacca N.,Sistemi
3IC,2,4,Gialli S.,Sistemi,,,
2AB,1,1,Rossi M.,Matematica,,,
2AB,1,2,Verdi G.,Scienze,Lab Chimica,Verdi G.,Scienze
2AB,1,2,Blu T.,Scienze,,,
2AB,2,3,Rossi M.,Matematica,Lab Info 1,Rossi M.,Matematica
2AB,2,3,Verdi G.,Matematica,,,
2AB,3,1,Vacca N.,Informatica,,,
2AB,3,2,Vacca N.,Informatica,Lab Info 1,Vacca N.,Informatica
2AB,3,2,Gialli S.,Informatica,,,
4DE,3,1,Bianchi L.,Italiano,,,
4DE,3,2,Bianchi L.,Italiano,,,
4DE,4,3,Vacca N.,Sistemi,Lab Info 1,Vacca N.,Sistemi
4DE,4,3,Blu T.,Sistemi,,,
1CD,4,4,Verdi G.,Scienze,Lab Chimica,Verdi G.,Scienze
1CD,4,4,Rossi M.,Scienze,,,
5EF,5,2,Verdi G.,Scienze,,,
5EF,5,3,Neri P.,Informatica,Lab Info 2,Neri P.,Informatica
5EF,5,3,Vacca N.,Informatica,,,`;

            console.log('Caricamento dati di esempio...');
            parseCSV(sampleCSV);
            
            document.getElementById('searchSection').style.display = 'block';
        }

        // Mostra upload manuale con dati di esempio
        function showManualUploadWithSample() {
            showManualUpload();
            
            // Aggiungi pulsante per riprovare il caricamento automatico
            const statusSection = document.querySelector('.status-section');
            if (!document.getElementById('retryBtn')) {
                const retryButton = document.createElement('button');
                retryButton.id = 'retryBtn';
                retryButton.className = 'retry-btn';
                retryButton.innerHTML = 'üîÑ Riprova caricamento automatico';
                retryButton.onclick = function() {
                    // Rimuovi elementi di errore
                    const messageArea = document.getElementById('messageArea');
                    if (messageArea) messageArea.style.display = 'none';
                    
                    // Riprova il caricamento
                    loadCSVFromURL();
                };
                statusSection.appendChild(retryButton);
            }
            
            // Carica alcuni dati di esempio per test
            const sampleCSV = `Classe,Giorno,Ora,Docente,Materia,Laboratorio,DocenteLab,DocenteLabMateria
3IC,1,2,Esempio D.,Informatica,,,
1TrED,5,3,Test T.,Matematica,Lab Info 1,Test T.,Matematica
3TrED,3,5,Demo D.,Fisica,,,`;
            
            // Aggiungi un messaggio informativo
            const messageArea = document.getElementById('messageArea') || createMessageArea();
            messageArea.className = 'info-message';
            messageArea.innerHTML = `
                ‚ÑπÔ∏è <strong>Modalit√† offline</strong><br>
                Il caricamento automatico da GitHub non √® riuscito.<br>
                Possibili cause: firewall, proxy aziendale, estensioni del browser.<br>
                <strong>Soluzioni:</strong><br>
                ‚Ä¢ Usa il pulsante "üìÅ Carica file CSV manualmente"<br>
                ‚Ä¢ Oppure clicca "üîÑ Riprova caricamento automatico"
            `;
            messageArea.style.display = 'block';
        }
        
        // Crea area messaggi se non esiste
        function createMessageArea() {
            const searchSection = document.getElementById('searchSection');
            const messageArea = document.createElement('div');
            messageArea.id = 'messageArea';
            searchSection.appendChild(messageArea);
            return messageArea;
        }

        // Mostra opzione per caricamento manuale se il download automatico fallisce
        function showManualUpload() {
            const statusSection = document.querySelector('.status-section');
            
            // Verifica se l'upload manuale √® gi√† presente
            if (document.getElementById('csvFile')) return;
            
            const uploadDiv = document.createElement('div');
            uploadDiv.style.marginTop = '20px';
            uploadDiv.innerHTML = `
                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                <label for="csvFile" style="
                    padding: 12px 24px;
                    background: #667eea;
                    color: white;
                    border-radius: 8px;
                    cursor: pointer;
                    display: inline-block;
                    font-weight: 600;
                    transition: all 0.3s ease;
                ">üìÅ Carica file CSV manualmente</label>
            `;
            statusSection.appendChild(uploadDiv);

            document.getElementById('csvFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const text = event.target.result;
                    parseCSV(text);
                    document.getElementById('statusIndicator').className = 'status-indicator success';
                    document.getElementById('statusIndicator').innerHTML = '‚úÖ File caricato con successo!';
                    document.getElementById('searchSection').style.display = 'block';
                    
                    // Nascondi messaggi dopo 3 secondi
                    setTimeout(() => {
                        document.getElementById('statusIndicator').style.display = 'none';
                        const messageArea = document.getElementById('messageArea');
                        if (messageArea) messageArea.style.display = 'none';
                    }, 3000);
                };
                reader.readAsText(file);
            });
        }

        // Parse CSV con la struttura corretta
        function parseCSV(text) {
            // Usa PapaParse per un parsing robusto
            const results = Papa.parse(text, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                delimiter: ','
            });

            csvData = results.data;
            teachers.clear();
            classes.clear();
            laboratories.clear();

            // Estrai docenti, classi e laboratori
            csvData.forEach(row => {
                // Docenti
                if (row.Docente && row.Docente.trim()) {
                    teachers.add(row.Docente.trim());
                }
                if (row.DocenteLab && row.DocenteLab.trim()) {
                    teachers.add(row.DocenteLab.trim());
                }
                
                // Classi
                if (row.Classe && row.Classe.trim()) {
                    classes.add(row.Classe.trim());
                }
                
                // Laboratori
                if (row.Laboratorio && row.Laboratorio.trim()) {
                    laboratories.add(row.Laboratorio.trim());
                }
            });

            console.log('Docenti trovati:', Array.from(teachers).sort());
            console.log('Classi trovate:', Array.from(classes).sort());
            console.log('Laboratori trovati:', Array.from(laboratories).sort());
            console.log('Righe totali:', csvData.length);

            // Popola il select in base alla vista corrente
            switch(currentView) {
                case 'docente':
                    populateTeacherSelect();
                    break;
                case 'classe':
                    populateClassSelect();
                    break;
                case 'laboratorio':
                    populateLaboratorySelect();
                    break;
            }
        }

        // Popola il select con i docenti
        function populateTeacherSelect() {
            const select = document.getElementById('searchSelect');
            select.innerHTML = '<option value="">-- Seleziona un docente --</option>';
            
            const sortedTeachers = Array.from(teachers).sort();
            sortedTeachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher;
                option.textContent = teacher;
                select.appendChild(option);
            });

            console.log(`Popolato select con ${sortedTeachers.length} docenti`);
        }

        // Popola il select con le classi
        function populateClassSelect() {
            const select = document.getElementById('searchSelect');
            select.innerHTML = '<option value="">-- Seleziona una classe --</option>';
            
            const sortedClasses = Array.from(classes).sort();
            sortedClasses.forEach(classe => {
                const option = document.createElement('option');
                option.value = classe;
                option.textContent = classe;
                select.appendChild(option);
            });

            console.log(`Popolato select con ${sortedClasses.length} classi`);
        }

        // Popola il select con i laboratori
        function populateLaboratorySelect() {
            const select = document.getElementById('searchSelect');
            select.innerHTML = '<option value="">-- Seleziona un laboratorio --</option>';
            
            const sortedLabs = Array.from(laboratories).sort();
            sortedLabs.forEach(lab => {
                const option = document.createElement('option');
                option.value = lab;
                option.textContent = lab;
                select.appendChild(option);
            });

            console.log(`Popolato select con ${sortedLabs.length} laboratori`);
        }

        // Ricerca in tempo reale
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const select = document.getElementById('searchSelect');
            
            if (searchTerm) {
                let matchingItems = [];
                
                switch(currentView) {
                    case 'docente':
                        matchingItems = Array.from(teachers)
                            .filter(t => t.toLowerCase().includes(searchTerm))
                            .sort();
                        break;
                    case 'classe':
                        matchingItems = Array.from(classes)
                            .filter(c => c.toLowerCase().includes(searchTerm))
                            .sort();
                        break;
                    case 'laboratorio':
                        matchingItems = Array.from(laboratories)
                            .filter(l => l.toLowerCase().includes(searchTerm))
                            .sort();
                        break;
                }
                
                if (matchingItems.length > 0) {
                    select.value = matchingItems[0];
                }
            }
        });

        // Sincronizza select con input di ricerca
        document.getElementById('searchSelect').addEventListener('change', function(e) {
            if (e.target.value) {
                document.getElementById('searchInput').value = e.target.value;
            }
        });

        // Visualizza orario
        document.getElementById('searchBtn').addEventListener('click', function() {
            const selectedValue = document.getElementById('searchSelect').value;
            if (!selectedValue) {
                let itemType = currentView === 'docente' ? 'un docente' : 
                              currentView === 'classe' ? 'una classe' : 
                              'un laboratorio';
                showMessage(`Seleziona ${itemType} prima di visualizzare l'orario`, 'error');
                return;
            }
            
            switch(currentView) {
                case 'docente':
                    displayScheduleDocente(selectedValue);
                    break;
                case 'classe':
                    displayScheduleClasse(selectedValue);
                    break;
                case 'laboratorio':
                    displayScheduleLaboratorio(selectedValue);
                    break;
            }
        });

        // Mostra messaggi
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            messageArea.className = type === 'error' ? 'error-message' : 'info-message';
            messageArea.textContent = message;
            messageArea.style.display = 'block';
            
            setTimeout(() => {
                messageArea.style.display = 'none';
            }, 5000);
        }

        // Mostra l'orario del docente
        function displayScheduleDocente(teacherName) {
            // Filtra i dati per il docente selezionato
            // Cerca sia nella colonna Docente che DocenteLab
            const teacherData = csvData.filter(row => {
                return row.Docente === teacherName || row.DocenteLab === teacherName;
            });

            console.log(`Trovate ${teacherData.length} righe per ${teacherName}`);

            if (teacherData.length === 0) {
                showMessage(`Nessun dato trovato per ${teacherName}`, 'error');
                return;
            }

            // Calcola statistiche
            const classiUniche = new Set();
            const materiUniche = new Set();
            const labUniche = new Set();
            let oreSettimanali = 0;

            teacherData.forEach(row => {
                if (row.Classe) classiUniche.add(row.Classe);
                if (row.Materia || row.DocenteLabMateria) {
                    materiUniche.add(row.Materia || row.DocenteLabMateria);
                }
                if (row.Laboratorio) labUniche.add(row.Laboratorio);
                oreSettimanali++;
            });

            // Mostra info docente con statistiche
            document.getElementById('teacherInfo').innerHTML = `
                <h2>üë®‚Äçüè´ ${teacherName}</h2>
                <div class="stats">
                    <span class="stat-item">üìä Ore settimanali: ${oreSettimanali}</span>
                    <span class="stat-item">üìö Classi: ${classiUniche.size}</span>
                    <span class="stat-item">üìñ Materie: ${materiUniche.size}</span>
                    ${labUniche.size > 0 ? `<span class="stat-item">üî¨ Laboratori: ${labUniche.size}</span>` : ''}
                </div>
            `;

            // Organizza i dati per giorno e ora
            const schedule = {};
            const hours = ['1¬™ ora', '2¬™ ora', '3¬™ ora', '4¬™ ora', '5¬™ ora', '6¬™ ora', '7¬™ ora', '8¬™ ora'];
            const days = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨'];

            // Inizializza la struttura
            hours.forEach(hour => {
                schedule[hour] = {};
                days.forEach(day => {
                    schedule[hour][day] = null;
                });
            });

            // Funzione per trovare compresenze
            function findCompresenza(currentRow, teacherName) {
                // Se Laboratorio != "" and DocenteLab != Docente then compresenza=DocenteLab
                if (currentRow.Laboratorio && currentRow.DocenteLab && currentRow.DocenteLab !== teacherName) {
                    return currentRow.DocenteLab;
                }
                
                // Se Laboratorio != "" and DocenteLab == Docente then trova DocenteX
                if (currentRow.Laboratorio && currentRow.DocenteLab === teacherName) {
                    // Cerca un altro docente con stessa classe, giorno, ora
                    const compresenzaRow = csvData.find(row => {
                        return row.Classe === currentRow.Classe &&
                               row.Giorno === currentRow.Giorno &&
                               row.Ora === currentRow.Ora &&
                               row.Docente !== teacherName &&
                               row.Docente !== currentRow.DocenteLab;
                    });
                    
                    if (compresenzaRow && compresenzaRow.Docente) {
                        return compresenzaRow.Docente;
                    }
                }
                
                return null;
            }

            // Popola l'orario
            teacherData.forEach(row => {
                const giorno = dayMapping[row.Giorno];
                const ora = row.Ora ? `${row.Ora}¬™ ora` : null;
                
                if (giorno && ora && schedule[ora]) {
                    // Determina se √® una lezione normale o in laboratorio
                    const isLabSession = row.DocenteLab === teacherName;
                    
                    // Trova la compresenza
                    const compresenza = findCompresenza(row, teacherName);
                    
                    schedule[ora][giorno] = {
                        classe: row.Classe || '',
                        materia: isLabSession ? (row.DocenteLabMateria || row.Materia || '') : (row.Materia || ''),
                        laboratorio: row.Laboratorio || '',
                        isLabSession: isLabSession,
                        compresenza: compresenza
                    };
                }
            });

            // Genera la tabella HTML
            updateScheduleTableDocente(schedule, hours, days);

            // Mostra la sezione orario
            document.getElementById('scheduleSection').style.display = 'block';
            
            // Scrolla fino all'orario
            document.getElementById('scheduleSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        // Funzione per aggiornare la tabella per docente
        function updateScheduleTableDocente(schedule, hours, days) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            // Ottieni lo stato dei checkbox
            const showLab = document.getElementById('showLab').checked;
            const showCompresenze = document.getElementById('showCompresenze').checked;

            hours.forEach(hour => {
                const row = document.createElement('tr');
                
                // Colonna ora
                const timeCell = document.createElement('td');
                timeCell.className = 'time-slot';
                timeCell.textContent = hour;
                row.appendChild(timeCell);

                // Colonne giorni
                days.forEach(day => {
                    const cell = document.createElement('td');
                    const lesson = schedule[hour][day];
                    
                    if (lesson && lesson.classe) {
                        const classType = lesson.isLabSession ? 'class-info lab-session' : 'class-info';
                        let cellContent = `
                            <div class="${classType}">
                                <span class="class-name">${lesson.classe}</span>
                                ${lesson.materia ? `<span class="subject-name">${lesson.materia}</span>` : ''}
                        `;
                        
                        // Mostra laboratorio se checkbox attivo
                        if (showLab && lesson.laboratorio) {
                            cellContent += `<span class="lab-info">üìç ${lesson.laboratorio}</span>`;
                        }
                        
                        // Mostra compresenza se checkbox attivo
                        if (showCompresenze && lesson.compresenza) {
                            cellContent += `<span class="compresenza-info">üë• con ${lesson.compresenza}</span>`;
                        }
                        
                        cellContent += '</div>';
                        cell.innerHTML = cellContent;
                    } else {
                        cell.innerHTML = '<span class="empty-slot">-</span>';
                    }
                    
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        // Mostra l'orario della classe
        function displayScheduleClasse(className) {
            // Filtra i dati per la classe selezionata
            const classData = csvData.filter(row => row.Classe === className);

            console.log(`Trovate ${classData.length} righe per classe ${className}`);

            if (classData.length === 0) {
                showMessage(`Nessun dato trovato per la classe ${className}`, 'error');
                return;
            }

            // Calcola statistiche
            const docentiUniche = new Set();
            const materiUniche = new Set();
            const labUniche = new Set();
            let oreSettimanali = classData.length;

            classData.forEach(row => {
                if (row.Docente) docentiUniche.add(row.Docente);
                if (row.DocenteLab) docentiUniche.add(row.DocenteLab);
                if (row.Materia) materiUniche.add(row.Materia);
                if (row.DocenteLabMateria) materiUniche.add(row.DocenteLabMateria);
                if (row.Laboratorio) labUniche.add(row.Laboratorio);
            });

            // Mostra info classe
            document.getElementById('teacherInfo').innerHTML = `
                <h2>üìö Classe ${className}</h2>
                <div class="stats">
                    <span class="stat-item">üìä Ore settimanali: ${oreSettimanali}</span>
                    <span class="stat-item">üë®‚Äçüè´ Docenti: ${docentiUniche.size}</span>
                    <span class="stat-item">üìñ Materie: ${materiUniche.size}</span>
                    ${labUniche.size > 0 ? `<span class="stat-item">üî¨ Laboratori: ${labUniche.size}</span>` : ''}
                </div>
            `;

            // Organizza i dati per giorno e ora
            const schedule = {};
            const hours = ['1¬™ ora', '2¬™ ora', '3¬™ ora', '4¬™ ora', '5¬™ ora', '6¬™ ora', '7¬™ ora', '8¬™ ora'];
            const days = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨'];

            // Inizializza la struttura
            hours.forEach(hour => {
                schedule[hour] = {};
                days.forEach(day => {
                    schedule[hour][day] = [];
                });
            });

            // Popola l'orario - pu√≤ avere pi√π docenti per ora
            classData.forEach(row => {
                const giorno = dayMapping[row.Giorno];
                const ora = row.Ora ? `${row.Ora}¬™ ora` : null;
                
                if (giorno && ora && schedule[ora]) {
                    schedule[ora][giorno].push({
                        materia: row.Materia || row.DocenteLabMateria || '',
                        docente: row.Docente || '',
                        docenteLab: row.DocenteLab || '',
                        laboratorio: row.Laboratorio || ''
                    });
                }
            });

            // Genera la tabella HTML
            updateScheduleTableClasse(schedule, hours, days);

            // Mostra la sezione orario
            document.getElementById('scheduleSection').style.display = 'block';
            
            // Scrolla fino all'orario
            document.getElementById('scheduleSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        // Funzione per aggiornare la tabella per classe
        function updateScheduleTableClasse(schedule, hours, days) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            // Ottieni lo stato dei checkbox
            const showDocente = document.getElementById('showDocenteClasse').checked;
            const showLab = document.getElementById('showLabClasse').checked;

            hours.forEach(hour => {
                const row = document.createElement('tr');
                
                // Colonna ora
                const timeCell = document.createElement('td');
                timeCell.className = 'time-slot';
                timeCell.textContent = hour;
                row.appendChild(timeCell);

                // Colonne giorni
                days.forEach(day => {
                    const cell = document.createElement('td');
                    const lessons = schedule[hour][day];
                    
                    if (lessons && lessons.length > 0) {
                        let cellContent = '<div class="class-info">';
                        
                        // Raggruppa per materia
                        const materiaMap = {};
                        lessons.forEach(lesson => {
                            const key = lesson.materia || 'Senza materia';
                            if (!materiaMap[key]) {
                                materiaMap[key] = {
                                    docenti: [],
                                    laboratori: []
                                };
                            }
                            if (lesson.docente) materiaMap[key].docenti.push(lesson.docente);
                            if (lesson.docenteLab && lesson.docenteLab !== lesson.docente) {
                                materiaMap[key].docenti.push(lesson.docenteLab);
                            }
                            if (lesson.laboratorio) materiaMap[key].laboratori.push(lesson.laboratorio);
                        });
                        
                        // Visualizza ogni materia
                        for (const [materia, info] of Object.entries(materiaMap)) {
                            cellContent += `<span class="class-name">${materia}</span>`;
                            
                            // Mostra docenti se checkbox attivo
                            if (showDocente && info.docenti.length > 0) {
                                const docentiUnique = [...new Set(info.docenti)];
                                docentiUnique.forEach(doc => {
                                    cellContent += `<span class="docente-info">üë®‚Äçüè´ ${doc}</span>`;
                                });
                            }
                            
                            // Mostra laboratorio se checkbox attivo
                            if (showLab && info.laboratori.length > 0) {
                                const labUnique = [...new Set(info.laboratori)];
                                labUnique.forEach(lab => {
                                    cellContent += `<span class="lab-info">üìç ${lab}</span>`;
                                });
                            }
                        }
                        
                        cellContent += '</div>';
                        cell.innerHTML = cellContent;
                    } else {
                        cell.innerHTML = '<span class="empty-slot">-</span>';
                    }
                    
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        // Mostra l'orario del laboratorio
        function displayScheduleLaboratorio(labName) {
            // Filtra i dati per il laboratorio selezionato
            const labData = csvData.filter(row => row.Laboratorio === labName);

            console.log(`Trovate ${labData.length} righe per laboratorio ${labName}`);

            if (labData.length === 0) {
                showMessage(`Nessun dato trovato per il laboratorio ${labName}`, 'error');
                return;
            }

            // Calcola statistiche
            const classiUniche = new Set();
            const docentiUniche = new Set();
            const materiUniche = new Set();
            let oreSettimanali = labData.length;

            labData.forEach(row => {
                if (row.Classe) classiUniche.add(row.Classe);
                if (row.DocenteLab) docentiUniche.add(row.DocenteLab);
                if (row.Docente) docentiUniche.add(row.Docente);
                if (row.DocenteLabMateria) materiUniche.add(row.DocenteLabMateria);
            });

            // Mostra info laboratorio
            document.getElementById('teacherInfo').innerHTML = `
                <h2>üî¨ ${labName}</h2>
                <div class="stats">
                    <span class="stat-item">üìä Ore di utilizzo: ${oreSettimanali}</span>
                    <span class="stat-item">üìö Classi: ${classiUniche.size}</span>
                    <span class="stat-item">üë®‚Äçüè´ Docenti: ${docentiUniche.size}</span>
                    <span class="stat-item">üìñ Materie: ${materiUniche.size}</span>
                </div>
            `;

            // Organizza i dati per giorno e ora
            const schedule = {};
            const hours = ['1¬™ ora', '2¬™ ora', '3¬™ ora', '4¬™ ora', '5¬™ ora', '6¬™ ora', '7¬™ ora', '8¬™ ora'];
            const days = ['Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨'];

            // Inizializza la struttura
            hours.forEach(hour => {
                schedule[hour] = {};
                days.forEach(day => {
                    schedule[hour][day] = null;
                });
            });

            // Popola l'orario
            labData.forEach(row => {
                const giorno = dayMapping[row.Giorno];
                const ora = row.Ora ? `${row.Ora}¬™ ora` : null;
                
                if (giorno && ora && schedule[ora]) {
                    // Trova eventuali compresenze (altri docenti nella stessa classe/ora)
                    const compresenze = csvData.filter(r => 
                        r.Classe === row.Classe &&
                        r.Giorno === row.Giorno &&
                        r.Ora === row.Ora &&
                        r.Docente !== row.DocenteLab &&
                        r.Laboratorio !== row.Laboratorio
                    ).map(r => r.Docente);
                    
                    schedule[ora][giorno] = {
                        classe: row.Classe || '',
                        materia: row.DocenteLabMateria || row.Materia || '',
                        docenteLab: row.DocenteLab || '',
                        compresenze: [...new Set(compresenze)]
                    };
                }
            });

            // Genera la tabella HTML
            updateScheduleTableLaboratorio(schedule, hours, days);

            // Mostra la sezione orario
            document.getElementById('scheduleSection').style.display = 'block';
            
            // Scrolla fino all'orario
            document.getElementById('scheduleSection').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }

        // Funzione per aggiornare la tabella per laboratorio
        function updateScheduleTableLaboratorio(schedule, hours, days) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            // Ottieni lo stato dei checkbox
            const showCompresenze = document.getElementById('showCompresenzeLab').checked;

            hours.forEach(hour => {
                const row = document.createElement('tr');
                
                // Colonna ora
                const timeCell = document.createElement('td');
                timeCell.className = 'time-slot';
                timeCell.textContent = hour;
                row.appendChild(timeCell);

                // Colonne giorni
                days.forEach(day => {
                    const cell = document.createElement('td');
                    const lesson = schedule[hour][day];
                    
                    if (lesson && lesson.classe) {
                        let cellContent = `
                            <div class="class-info lab-session">
                                <span class="class-name">${lesson.classe}</span>
                                ${lesson.materia ? `<span class="subject-name">${lesson.materia}</span>` : ''}
                                ${lesson.docenteLab ? `<span class="docente-lab-info">üî¨ ${lesson.docenteLab}</span>` : ''}
                        `;
                        
                        // Mostra compresenze se checkbox attivo
                        if (showCompresenze && lesson.compresenze && lesson.compresenze.length > 0) {
                            lesson.compresenze.forEach(doc => {
                                cellContent += `<span class="compresenza-info">üë• con ${doc}</span>`;
                            });
                        }
                        
                        cellContent += '</div>';
                        cell.innerHTML = cellContent;
                    } else {
                        cell.innerHTML = '<span class="empty-slot">-</span>';
                    }
                    
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        // Aggiungi listener per i checkbox
        document.addEventListener('DOMContentLoaded', function() {
            // Checkbox per vista docente
            const showLabCheckbox = document.getElementById('showLab');
            const showCompresenzeCheckbox = document.getElementById('showCompresenze');
            
            // Checkbox per vista classe
            const showDocenteClasseCheckbox = document.getElementById('showDocenteClasse');
            const showLabClasseCheckbox = document.getElementById('showLabClasse');
            
            // Checkbox per vista laboratorio
            const showCompresenzeLabCheckbox = document.getElementById('showCompresenzeLab');
            
            // Funzione per aggiornare la visualizzazione quando cambiano i checkbox
            function updateDisplay() {
                const selectedValue = document.getElementById('searchSelect').value;
                if (selectedValue) {
                    switch(currentView) {
                        case 'docente':
                            displayScheduleDocente(selectedValue);
                            break;
                        case 'classe':
                            displayScheduleClasse(selectedValue);
                            break;
                        case 'laboratorio':
                            displayScheduleLaboratorio(selectedValue);
                            break;
                    }
                }
            }
            
            // Aggiungi listener a tutti i checkbox
            if (showLabCheckbox) showLabCheckbox.addEventListener('change', updateDisplay);
            if (showCompresenzeCheckbox) showCompresenzeCheckbox.addEventListener('change', updateDisplay);
            if (showDocenteClasseCheckbox) showDocenteClasseCheckbox.addEventListener('change', updateDisplay);
            if (showLabClasseCheckbox) showLabClasseCheckbox.addEventListener('change', updateDisplay);
            if (showCompresenzeLabCheckbox) showCompresenzeLabCheckbox.addEventListener('change', updateDisplay);
        });

        // Gestione enter sulla ricerca
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });
    </script>
</body>
</html>